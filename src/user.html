<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>我的订单 - 数字商品交易平台</title>
    <script src="https://cdn.tailwindcss.com"></script>
  <script>
    (function(){
      function ensureTailwind(){
        try {
          var probe = document.createElement('div');
          probe.className = 'hidden';
          document.head.appendChild(probe);
          var style = window.getComputedStyle(probe);
          var ok = style && (style.display === 'none');
          document.head.removeChild(probe);
          if (!ok) {
            var s = document.createElement('script');
            s.src = 'https://cdn.tailwindcss.com';
            document.head.appendChild(s);
          }
        } catch (_) {}
      }
      ensureTailwind();
    })();
  </script>
  <script src="/assets/js/common.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="container mx-auto px-4 py-6">
    <!-- 页面标题 -->
    <div class="mb-6">
      <h1 class="text-2xl font-bold text-gray-900">我的订单</h1>
      <p class="text-gray-600">管理您的购买记录和已购商品</p>
    </div>

    <!-- 导航标签 -->
    <div class="mb-6">
      <nav class="flex space-x-1 bg-gray-100 p-1 rounded-lg">
        <button id="tab-orders" class="tab-btn px-4 py-2 rounded-md text-sm font-medium tab-active" data-tab="orders">
          我的订单
        </button>
        <button id="tab-purchases" class="tab-btn px-4 py-2 rounded-md text-sm font-medium tab-inactive" data-tab="purchases">
          已购清单
        </button>
      </nav>
    </div>

    <!-- 内容区域 -->
    <div class="grid grid-cols-1 gap-6">
      
      <!-- 我的订单 -->
      <section id="section-orders" class="tab-section">
        <div class="card p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold">订单列表</h2>
            <div class="flex items-center gap-2">
              <select id="sel-order-status" class="px-3 py-2 border rounded text-sm">
                <option value="">全部状态</option>
                <option value="pending">待支付</option>
                <option value="paid">已支付</option>
                <option value="completed">已完成</option>
              </select>
              <button id="btn-orders-refresh" class="btn btn-primary">刷新</button>
            </div>
          </div>
          
          <div id="orders-list" class="space-y-4">
            <div class="text-sm text-gray-500 text-center py-4">点击"刷新"加载订单列表</div>
          </div>
        </div>
      </section>

      <!-- 已购清单 -->
      <section id="section-purchases" class="tab-section hidden">
        <div class="card p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold">已购商品</h2>
            <button id="btn-purchases-refresh" class="btn btn-primary">刷新</button>
          </div>
          
          <div id="purchases-list" class="space-y-4">
            <div class="text-sm text-gray-500 text-center py-4">点击"刷新"加载已购商品</div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    (function() {
      // 全局变量
      let currentBuyerId = null;
      let currentTab = 'orders';

      // 初始化
      async function init() {
        await getCurrentUser();
        bindEvents();
        loadTabContent(currentTab);
        // 启动通知轮询更新徽标（若该页后续加徽标，可直接取 count）
        try {
          Global.NotificationPoller.startPolling(()=>{});
        } catch(_) {}
      }

      // 获取当前用户
      async function getCurrentUser() {
        try {
          // 优先本地缓存
          try {
            const cached = Global.SessionManager.getStoredUserInfo && Global.SessionManager.getStoredUserInfo();
            if (cached && cached.user_id) {
              currentBuyerId = cached.user_id;
            }
          } catch (_) {}
          const response = await fetch('/oauth/session/latest');
          const data = await response.json();
          
          if (data.status === 'success' && data.user_id) {
            currentBuyerId = data.user_id;
            try { if (data.session && data.session.session_id) localStorage.setItem('session_id', data.session.session_id); } catch {}
            try { localStorage.setItem('user_info', JSON.stringify(data)); } catch {}
            console.log('当前买家ID:', currentBuyerId);
          } else {
            window.location.href = '/login';
            return;
          }
        } catch (error) {
          console.error('获取用户信息失败:', error);
          Global.notify('获取用户信息失败，请重新登录', 'error');
          setTimeout(() => {
            window.location.href = '/login';
          }, 2000);
        }
      }

      // 绑定事件
      function bindEvents() {
        // 标签切换
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const tab = btn.getAttribute('data-tab');
            switchTab(tab);
          });
        });

        // 刷新按钮
        document.getElementById('btn-orders-refresh')?.addEventListener('click', () => loadOrders());
        document.getElementById('btn-purchases-refresh')?.addEventListener('click', () => loadPurchases());
      }

      // 切换标签
      function switchTab(tab) {
        currentTab = tab;
        
        // 更新标签样式
        document.querySelectorAll('.tab-btn').forEach(btn => {
          if (btn.getAttribute('data-tab') === tab) {
            btn.className = btn.className.replace('tab-inactive', 'tab-active');
          } else {
            btn.className = btn.className.replace('tab-active', 'tab-inactive');
          }
        });

        // 显示/隐藏内容
        document.querySelectorAll('.tab-section').forEach(section => {
          if (section.id === `section-${tab}`) {
            section.classList.remove('hidden');
          } else {
            section.classList.add('hidden');
          }
        });

        // 加载内容
        loadTabContent(tab);
      }

      // 加载标签内容
      async function loadTabContent(tab) {
        switch (tab) {
          case 'orders':
            await loadOrders();
            break;
          case 'purchases':
            await loadPurchases();
            break;
        }
      }

      // 加载订单列表
      async function loadOrders() {
        if (!currentBuyerId) return;

        try {
          const sessionId = (()=>{ try { return localStorage.getItem('session_id'); } catch { return null; } })();
          const status = document.getElementById('sel-order-status')?.value || '';
          const url = status ? `/api/orders/mine?buyer_id=${currentBuyerId}&status=${status}` : 
                              `/api/orders/mine?buyer_id=${currentBuyerId}`;
          
          const response = await fetch(url, { headers: sessionId ? { 'X-Session-Id': sessionId } : {} });
          const data = await response.json();
          
          const container = document.getElementById('orders-list');
          if (!container) return;
          
          if (data.status === 'success' && data.orders.length > 0) {
            const html = data.orders.map(order => `
              <div class="border rounded-lg p-4 hover:bg-gray-50">
                <div class="flex items-center justify-between mb-3">
                  <div>
                    <h3 class="font-semibold">订单 ${order.order_no}</h3>
                    <p class="text-sm text-gray-600">下单时间: ${formatTime(order.created_at)}</p>
                  </div>
                  <div class="text-right">
                    <div class="text-lg font-bold text-green-600">¥${(order.total_amount_cents / 100).toFixed(2)}</div>
                    <div class="text-sm ${getStatusColor(order.status)}">${getStatusText(order.status)}</div>
                  </div>
                </div>
                
                <div class="mb-3">
                  <h4 class="text-sm font-medium text-gray-700 mb-2">订单商品:</h4>
                  <div class="space-y-2">
                    ${order.items.map(item => `
                      <div class="flex items-center justify-between text-sm bg-gray-50 rounded p-2">
                        <div>
                          <span class="font-medium">${item.title || '商品ID: ' + item.listing_id}</span>
                          <span class="text-gray-500 ml-2">x${item.quantity}</span>
                        </div>
                        <div class="text-green-600 font-medium">¥${(item.price_cents / 100).toFixed(2)}</div>
                      </div>
                    `).join('')}
                  </div>
                </div>
                
                <div class="flex items-center justify-between">
                  <div class="text-sm text-gray-500">
                    支付状态: <span class="${getStatusColor(order.payment_status)}">${getStatusText(order.payment_status)}</span>
                  </div>
                  <div class="flex gap-2">
                    ${order.status === 'pending' ? `
                      <button class="btn btn-primary" onclick="payOrder(${order.id})">立即支付</button>
                    ` : ''}
                    <button class="btn btn-secondary" onclick="viewOrderDetail(${order.id})">查看详情</button>
                  </div>
                </div>
              </div>
            `).join('');
            
            container.innerHTML = html;
          } else {
            container.innerHTML = '<div class="text-sm text-gray-500 text-center py-4">暂无订单</div>';
          }
        } catch (error) {
          Global.notify('加载订单列表失败: ' + error.message, 'error');
        }
      }

      // 加载已购商品
      async function loadPurchases() {
        if (!currentBuyerId) return;

        try {
          const sessionId = (()=>{ try { return localStorage.getItem('session_id'); } catch { return null; } })();
          const response = await fetch(`/api/purchases/mine?buyer_id=${currentBuyerId}`, { headers: sessionId ? { 'X-Session-Id': sessionId } : {} });
          const data = await response.json();
          
          const container = document.getElementById('purchases-list');
          if (!container) return;
          
          if (data.status === 'success' && data.purchases.length > 0) {
            const html = data.purchases.map(purchase => `
              <div class="border rounded-lg p-4 hover:bg-gray-50">
                <div class="flex items-center justify-between mb-3">
                  <div>
                    <h3 class="font-semibold">${purchase.title || '商品ID: ' + purchase.listing_id}</h3>
                    <p class="text-sm text-gray-600">购买时间: ${formatTime(purchase.created_at)}</p>
                  </div>
                  <div class="text-right">
                    <div class="text-sm text-gray-500">下载次数: ${purchase.download_count}</div>
                    <div class="text-sm ${getStatusColor(purchase.order_status)}">${getStatusText(purchase.order_status)}</div>
                  </div>
                </div>
                
                <div class="mb-3">
                  <h4 class="text-sm font-medium text-gray-700 mb-2">文件信息:</h4>
                  <div class="bg-gray-50 rounded p-3">
                    <div class="text-sm font-mono text-gray-600 break-all">
                      ${purchase.file_path}
                    </div>
                    <div class="mt-2 flex gap-2">
                      <button class="btn btn-primary" onclick="copyPath('${purchase.file_path}')">复制路径</button>
                      <button class="btn btn-success" onclick="downloadFile('${purchase.file_path}')">下载文件</button>
                    </div>
                  </div>
                </div>
                
                <div class="text-xs text-gray-500">
                  订单号: ${purchase.order_no} | 
                  最后访问: ${purchase.last_accessed_at ? formatTime(purchase.last_accessed_at) : '从未访问'}
                </div>
              </div>
            `).join('');
            
            container.innerHTML = html;
          } else {
            container.innerHTML = '<div class="text-sm text-gray-500 text-center py-4">暂无已购商品</div>';
          }
        } catch (error) {
          Global.notify('加载已购商品失败: ' + error.message, 'error');
        }
      }

      // 支付订单
      async function payOrder(orderId) {
        try {
          const sessionId = (()=>{ try { return localStorage.getItem('session_id'); } catch { return null; } })();
          const isMobile = (()=>{ const ua=navigator.userAgent||''; return /(Android|iPhone|iPad|iPod|Mobile)/i.test(ua) || Math.min(window.innerWidth, window.innerHeight)<=420; })();
          const response = await fetch(`/api/orders/${orderId}/pay`, {
            method: 'POST',
            headers: Object.assign({ 'Content-Type': 'application/json' }, (sessionId ? { 'X-Session-Id': sessionId } : {})),
            body: JSON.stringify({
              provider: 'alipay',
              payment_method: isMobile ? 'alipay_wap' : 'alipay'
            })
          });

          const data = await response.json();

          if (data.status === 'success') {
            // 显示支付模态框
            showPaymentModal(data, orderId);
          } else {
            Global.notify('发起支付失败: ' + data.message, 'error');
          }
        } catch (error) {
          Global.notify('支付失败: ' + error.message, 'error');
        }
      }

      // 显示支付模态框（真实支付流程，支持移动端直跳/PC二维码）
      function showPaymentModal(paymentData, orderId) {
        const isMobile = (()=>{
          const ua = navigator.userAgent || '';
          const m = /(Android|iPhone|iPad|iPod|Mobile)/i.test(ua);
          const small = Math.min(window.innerWidth, window.innerHeight) <= 420;
          return m || small;
        })();
        const amountY = (paymentData.amount_cents / 100).toFixed(2);
        const txid = paymentData.transaction_id;
        const payUrl = paymentData.payment_url || '';
        const qr = payUrl ? `https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=${encodeURIComponent(payUrl)}` : '';

        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        let remain = 120, tick = 0;
        function dots(n){ return '.'.repeat(n%3+1); }
        modal.innerHTML = `
          <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4">
            <div class="text-center mb-2 flex items-center justify-center gap-2">
              <h3 class="text-lg font-semibold">订单支付</h3>
              <span id="pay-loading-dot" class="text-gray-400 text-sm">···</span>
            </div>
            <div class="space-y-4">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
                <div class="text-center bg-gray-50 rounded p-4 shadow-sm">
                  <div class="text-3xl font-extrabold text-green-600 mb-2">¥${amountY}</div>
                  <p class="text-sm text-gray-600">交易号: <span class="mono" id="pay-txid">${txid}</span> <button id="btn-copy-txid" class="text-blue-600 text-xs underline">复制</button></p>
                  <p class="text-sm text-gray-600">支付方式: ${paymentData.provider || 'alipay'}</p>
                  ${payUrl ? `<a href="${payUrl}" target="${isMobile ? '_self' : '_blank'}" rel="noopener" class="btn btn-primary mt-3 inline-block">打开支付页面</a>` : ''}
                  <div id="pay-countdown" class="text-xs text-gray-500 mt-2">轮询剩余 ${remain}s</div>
                </div>
                <div class="text-center">
                  ${isMobile ? `<div class=\"text-sm text-gray-600\">已为移动端优化，请点击上方按钮跳转支付宝</div>` : (qr ? `<img src="${qr}" alt="支付宝支付二维码" class="inline-block rounded border bg-white p-2 shadow" style="width:220px;height:220px;object-fit:contain;" />` : '<div class="text-sm text-gray-500">正在生成支付二维码...</div>')}
                  ${(!isMobile && payUrl) ? `<div class="text-xs text-gray-500 mt-2">扫码遇到问题？点击上方“打开支付页面”</div>` : ''}
                </div>
              </div>

              <div class="text-center">
                <p class="text-sm text-gray-500 mb-3">完成支付后请点击下方按钮确认</p>
                <button id="btn-pay-success" class="btn btn-success px-8">确认支付成功</button>
              </div>

              <div class="text-center">
                <button id="btn-pay-cancel" class="btn btn-secondary px-6">取消支付</button>
              </div>
            </div>
          </div>
        `;

        document.body.appendChild(modal);

        // 事件绑定
        document.getElementById('btn-copy-txid')?.addEventListener('click', ()=>{
          const v = document.getElementById('pay-txid')?.textContent || '';
          if(!v) return; navigator.clipboard.writeText(v).then(()=> Global.notify('交易号已复制','success')).catch(()=> Global.notify('复制失败','error'));
        });
        document.getElementById('btn-pay-success').addEventListener('click', () => {
          startPaymentPolling(orderId, modal);
        });
        document.getElementById('btn-pay-cancel').addEventListener('click', () => {
          document.body.removeChild(modal);
        });

        // 动画与倒计时
        const dotEl = modal.querySelector('#pay-loading-dot');
        const cdEl = modal.querySelector('#pay-countdown');
        const anim = setInterval(()=>{
          tick++; remain--; if(remain<0){ clearInterval(anim); return; }
          if (dotEl) dotEl.textContent = dots(tick);
          if (cdEl) cdEl.textContent = `轮询剩余 ${remain}s`;
        }, 1000);

        // 移动端自动唤起
        if (isMobile && payUrl) {
          setTimeout(()=>{ try { window.location.href = payUrl; } catch(_) {} }, 100);
        }
      }

      // 开始支付状态轮询
      function startPaymentPolling(orderId, modal) {
        const pollingBtn = document.getElementById('btn-pay-polling');
        pollingBtn.textContent = '轮询中...';
        pollingBtn.disabled = true;
        
        let pollCount = 0;
        const maxPolls = 30; // 最多轮询30次（30秒）
        
        const pollInterval = setInterval(async () => {
          pollCount++;
          
          try {
            const sessionId = (()=>{ try { return localStorage.getItem('session_id'); } catch { return null; } })();
            const response = await fetch(`/api/orders/${orderId}`, { headers: sessionId ? { 'X-Session-Id': sessionId } : {} });
            const data = await response.json();
            
            if (data.status === 'success' && data.order) {
              const order = data.order;
              if (order.payment_status === 'success') {
                clearInterval(pollInterval);
                Global.notify('支付成功！', 'success');
                document.body.removeChild(modal);
                loadOrders(); // 刷新订单列表
                return;
              }
            }
          } catch (err) {
            console.error('轮询失败:', err);
          }
          
          // 如果轮询次数达到上限，停止轮询
          if (pollCount >= maxPolls) {
            clearInterval(pollInterval);
            pollingBtn.textContent = '轮询超时';
            Global.notify('支付状态轮询超时，请手动刷新', 'warn');
          }
        }, 1000);
      }

      // 处理支付成功
      async function handlePaymentSuccess(orderId, transactionId) {
        try {
          const sessionId = (()=>{ try { return localStorage.getItem('session_id'); } catch { return null; } })();
          const response = await fetch('/api/payment/callback', {
            method: 'POST',
            headers: Object.assign({ 'Content-Type': 'application/json' }, (sessionId ? { 'X-Session-Id': sessionId } : {})),
            body: JSON.stringify({
              order_id: orderId,
              provider: 'alipay',
              transaction_id: transactionId,
              status: 'success',
              message: '测试支付成功'
            })
          });

          const data = await response.json();

          if (data.status === 'success') {
            Global.notify('支付成功！', 'success');
            loadOrders(); // 刷新订单列表
          } else {
            Global.notify('支付处理失败: ' + data.message, 'error');
          }
        } catch (error) {
          Global.notify('支付处理失败: ' + error.message, 'error');
        }
      }

      // 查看订单详情
      function viewOrderDetail(orderId) {
        // 可以打开详情模态框或跳转到详情页面
        Global.notify('订单详情功能开发中...', 'info');
      }

      // 复制文件路径
      function copyPath(path) {
        navigator.clipboard.writeText(path).then(() => {
          Global.notify('文件路径已复制到剪贴板', 'success');
        }).catch(() => {
          Global.notify('复制失败，请手动复制', 'error');
        });
      }

      // 下载文件
      function downloadFile(path) {
        // 这里可以实现文件下载逻辑
        // 目前只是提示用户文件路径
        Global.notify(`文件路径: ${path}\n\n请使用百度网盘客户端下载`, 'info');
      }

      // 工具函数
      function getStatusColor(status) {
        const colors = {
          'pending': 'text-yellow-600',
          'paid': 'text-green-600',
          'completed': 'text-green-600',
          'success': 'text-green-600',
          'failed': 'text-red-600'
        };
        return colors[status] || 'text-gray-600';
      }

      function getStatusText(status) {
        const texts = {
          'pending': '待支付',
          'paid': '已支付',
          'completed': '已完成',
          'success': '成功',
          'failed': '失败'
        };
        return texts[status] || status;
      }

      function formatTime(timestamp) {
        if (!timestamp) return '';
        return new Date(timestamp * 1000).toLocaleString();
      }

      // 全局函数（供HTML调用）
      window.payOrder = payOrder;
      window.viewOrderDetail = viewOrderDetail;
      window.copyPath = copyPath;
      window.downloadFile = downloadFile;

      // 启动应用
      init();
    })();
  </script>
</body>
</html>